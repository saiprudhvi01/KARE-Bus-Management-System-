// Wait for the DOM to load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Socket.IO only if available
    let socket;
    if (typeof io !== 'undefined') {
        socket = io();
    }
    // Add active class to the current navigation link
    const currentLocation = location.pathname;
    const navLinks = document.querySelectorAll('.nav-link');
    
    navLinks.forEach(link => {
        if (link.getAttribute('href') === currentLocation) {
            link.classList.add('active');
        }
    });

    // Add form validation
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });

    // Password match validation for signup forms
    const signupForms = document.querySelectorAll('form[action^="/signup/"]');
    signupForms.forEach(form => {
        const password = form.querySelector('#password');
        const confirmPassword = form.querySelector('#confirmPassword');
        
        if (password && confirmPassword) {
            confirmPassword.addEventListener('input', function() {
                if (password.value !== confirmPassword.value) {
                    confirmPassword.setCustomValidity("Passwords don't match");
                } else {
                    confirmPassword.setCustomValidity('');
                }
            });
        }
    });

    // Toast initialization for notifications
    const toastElList = document.querySelectorAll('.toast');
    if (toastElList.length > 0) {
        toastElList.forEach(toastEl => {
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        });
    }
});

    // Socket.IO event listeners (only if socket is available)
    if (socket) {
        socket.on('connect', () => {
    console.log('Connected to server');
    
    // Join room based on user role (if logged in)
    const userElement = document.querySelector('[data-user-role]');
    if (userElement) {
        const userData = {
            role: userElement.dataset.userRole,
            name: userElement.dataset.userName || 'User'
        };
        socket.emit('joinRoom', userData);
    }
});

// Listen for new feedback
socket.on('feedbackReceived', (feedback) => {
    console.log('New feedback received:', feedback);
    
    // Show notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <strong>New Feedback!</strong><br>
        ${feedback.subject}<br>
        <small>From: ${feedback.studentName}</small>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
});

// Listen for bus location updates
socket.on('busLocationUpdate', (locationData) => {
    console.log('Bus location updated:', locationData);
    
    // Update bus location on tracking page
    const locationElement = document.getElementById('busLocation');
    if (locationElement) {
        locationElement.textContent = locationData.location || 'Location updated';
    }
});

// Listen for new bus requests
socket.on('busRequestReceived', (requestData) => {
    console.log('New bus request:', requestData);
    
    // Show notification for management
    const notification = document.createElement('div');
    notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <strong>New Bus Request!</strong><br>
        Student: ${requestData.studentName}<br>
        Bus: ${requestData.busName}<br>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
});

// Listen for request status updates
socket.on('requestStatusUpdate', (updateData) => {
    console.log('Request status updated:', updateData);
    
    // Determine alert class based on status
    let alertClass = 'alert-info';
    let badgeClass = 'bg-secondary';
    
    if (updateData.status === 'accepted') {
        alertClass = 'alert-success';
        badgeClass = 'bg-success';
    } else if (updateData.status === 'rejected') {
        alertClass = 'alert-danger';
        badgeClass = 'bg-danger';
    }
    
    // Show notification to student
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <strong>Request Updated!</strong><br>
        ${updateData.message}<br>
        Bus: ${updateData.busName}<br>
        Status: <span class="badge ${badgeClass}">${updateData.status}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
    
    // Refresh the page after 2 seconds to show updated status
    setTimeout(() => {
        window.location.reload();
    }, 2000);
    }
});