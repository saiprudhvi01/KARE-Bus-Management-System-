<%- include('../partials/header', { title: 'Bus Schedule' }) %>
<%- include('../partials/navbar-student') %>

<div class="container mt-4 animate__animated animate__fadeIn">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-success">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="card-title mb-0">
              <i class="fas fa-calendar-alt text-success me-2"></i> Bus Schedule
            </h2>
            <a href="/student/dashboard" class="btn btn-outline-success">
              <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% if (locals.error_msg) { %>
    <div class="alert alert-danger"><%= error_msg %></div>
  <% } %>
  
  <% if (locals.success_msg) { %>
    <div class="alert alert-success"><%= success_msg %></div>
  <% } %>

  <div class="row mb-4">
    <div class="col-lg-3 mb-4 mb-lg-0">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Filter Options</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="busFilter" class="form-label">Select Bus</label>
            <select id="busFilter" class="form-select">
              <option value="all">All Buses</option>
              <% if (typeof buses !== 'undefined' && buses.length > 0) { %>
                <% buses.forEach(bus => { %>
                  <option value="<%= bus.busId %>">
                    <%= bus.busName %> (#<%= bus.busId %>)
                  </option>
                <% }); %>
              <% } %>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="dayFilter" class="form-label">Day of Week</label>
            <select id="dayFilter" class="form-select">
              <option value="all">All Days</option>
              <option value="Mon" <%= today === 'Mon' ? 'selected' : '' %>>Monday</option>
              <option value="Tue" <%= today === 'Tue' ? 'selected' : '' %>>Tuesday</option>
              <option value="Wed" <%= today === 'Wed' ? 'selected' : '' %>>Wednesday</option>
              <option value="Thu" <%= today === 'Thu' ? 'selected' : '' %>>Thursday</option>
              <option value="Fri" <%= today === 'Fri' ? 'selected' : '' %>>Friday</option>
              <option value="Sat" <%= today === 'Sat' ? 'selected' : '' %>>Saturday</option>
              <option value="Sun" <%= today === 'Sun' ? 'selected' : '' %>>Sunday</option>
            </select>
          </div>
          
          <button id="applyFilters" class="btn btn-success w-100">
            <i class="fas fa-filter me-1"></i> Apply Filters
          </button>
        </div>
      </div>
    </div>
    
    <div class="col-lg-9">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            <i class="fas fa-clock me-2 text-success"></i> Bus Schedule
            <% if (today) { %>
              <span class="badge bg-success ms-2">
                <%= (['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].indexOf(today) !== -1) ?
                  ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
                    [['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].indexOf(today)] : today %>
              </span>
            <% } %>
          </h5>
        </div>
        <div class="card-body">
          <% if (typeof buses !== 'undefined' && buses.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Bus</th>
                    <th>Time</th>
                    <th>Route</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>Days</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="scheduleTableBody">
                  <% 
                    let scheduleItems = [];
                    
                    // Process each bus to extract schedule items
                    buses.forEach(bus => {
                      if (bus.schedule && bus.schedule.length > 0) {
                        bus.schedule.forEach(schedule => {
                          scheduleItems.push({
                            busId: bus.busId,
                            busName: bus.busName,
                            route: bus.route,
                            ...schedule
                          });
                        });
                      }
                    });
                    
                    // Sort schedule items by time
                    scheduleItems.sort((a, b) => {
                      // Parse time strings to get hours and minutes
                      const getTimeValue = (timeStr) => {
                        if (!timeStr) return 0; // Return 0 for invalid time strings
                        const isPM = timeStr.includes('PM');
                        let [hours, minutesStr] = timeStr.replace(' AM', '').replace(' PM', '').split(':');
                        hours = parseInt(hours) || 0;
                        const minutes = parseInt(minutesStr) || 0;
                        if (isPM && hours < 12) hours += 12;
                        if (!isPM && hours === 12) hours = 0;
                        return hours * 60 + minutes;
                      };
                      
                      return getTimeValue(a.time) - getTimeValue(b.time);
                    });
                    
                    if (scheduleItems.length > 0) {
                      scheduleItems.forEach(item => {
                  %>
                    <tr class="schedule-row" 
                        data-bus="<%= item.busId %>" 
                        data-days="<%= item.days && Array.isArray(item.days) ? item.days.join(',') : '' %>">
                      <td><%= item.busName %> (#<%= item.busId %>)</td>
                      <td><%= item.time %></td>
                      <td><%= item.route %></td>
                      <td><%= item.departure %></td>
                      <td><%= item.arrival %></td>
                      <td>
                        <% if (item.days && Array.isArray(item.days)) { %>
                          <% item.days.forEach(day => { %>
                            <span class="badge rounded-pill bg-light text-dark me-1"><%= day %></span>
                          <% }); %>
                        <% } else { %>
                          <span class="text-muted">No schedule</span>
                        <% } %>
                      </td>
                      <td>
                        <a href="/student/track/<%= item.busId %>" class="btn btn-sm btn-primary">
                          <i class="fas fa-map-marker-alt"></i> Track
                        </a>
                      </td>
                    </tr>
                  <% 
                      });
                    } else { 
                  %>
                    <tr>
                      <td colspan="7" class="text-center">No schedule items found</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i> No buses available with schedules.
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const busFilter = document.getElementById('busFilter');
    const dayFilter = document.getElementById('dayFilter');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const scheduleRows = document.querySelectorAll('.schedule-row');
    
    // Apply filters function
    function applyFilters() {
      const selectedBus = busFilter.value;
      const selectedDay = dayFilter.value;
      
      scheduleRows.forEach(row => {
        const busFits = selectedBus === 'all' || row.dataset.bus === selectedBus;
        const dayFits = selectedDay === 'all' || row.dataset.days.split(',').includes(selectedDay);
        
        row.style.display = busFits && dayFits ? '' : 'none';
      });
    }
    
    // Apply filters when button is clicked
    applyFiltersBtn.addEventListener('click', applyFilters);
    
    // Apply initial filters (if URL has busId parameter)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('busId')) {
      busFilter.value = urlParams.get('busId');
      applyFilters();
    }
  });
</script>

<%- include('../partials/footer') %> 